{"ast":null,"code":"import \"core-js/modules/web.url-search-params.delete.js\";\nimport \"core-js/modules/web.url-search-params.has.js\";\nimport \"core-js/modules/web.url-search-params.size.js\";\nimport instance from '@/service';\nimport { ref, onMounted, onBeforeUnmount } from 'vue';\nexport default {\n  __name: 'onlineAlaysis',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    const video = ref();\n    const video_result = ref();\n    let flag = 0;\n    const canvas = ref();\n    const canvas_result = ref();\n    const ctx = ref();\n    const socket = new WebSocket('ws://localhost:8888');\n    onMounted(() => {\n      console.log('正在打开摄像头。。。');\n      getCamera();\n      //连接后端socket\n      connection();\n      reconnection();\n    });\n    function connection() {\n      socket.onopen = () => {\n        console.log('socket 已打开...');\n      };\n    }\n    async function reconnection() {\n      console.log('Attempting to reconnect...');\n      setTimeout(connection(), 3000); // 3秒后尝试重新连接\n    }\n    function getCamera() {\n      canvas.value = document.getElementById('camera');\n      ctx.value = canvas.value.getContext('2d');\n      if (navigator.mediaDevices) {\n        navigator.mediaDevices.getUserMedia({\n          video: true,\n          audio: false\n        }).then(stream => {\n          video.value.srcObject = stream;\n          video.value.play();\n          let mediaRecorder = new MediaRecorder(stream);\n          mediaRecorder.ondataavailable = event => {\n            if (event.data && event.data.size > 0 && flag === 1) {\n              const canvas = document.createElement('canvas');\n              canvas.width = video.value.videoWidth;\n              canvas.height = video.value.videoHeight;\n              const ctx = canvas.getContext('2d');\n              ctx.drawImage(video.value, 0, 0, canvas.width, canvas.height);\n              // 将图像数据编码为 base64 字符串\n              const base64ImageData = canvas.toDataURL('image/jpeg');\n              // 发送 base64 编码后的图像数据给后端处理\n              //如果socket连接后才开始发送\n              socket.send(base64ImageData);\n            }\n          };\n          mediaRecorder.start(33);\n        }).catch(err => {\n          console.log(err);\n        });\n      } else {\n        //防止浏览器版本旧不支持mediaDevices\n        navigator.mediaDevices = {};\n      }\n    }\n    onBeforeUnmount(() => {\n      //closeCamera();\n    });\n    function closeCamera() {\n      let stream = video.value.srcObject;\n      if (!stream) return;\n      let tracks = stream.getTracks();\n      tracks.forEach(x => {\n        x.stop();\n      });\n    }\n    function getDetection() {\n      flag = 1;\n      console.log(\"开始检测\");\n      socket.onmessage = event => {\n        console.log(event.data);\n        let imageData = event.data;\n        // 检查是否为 Blob 对象\n        if (imageData instanceof Blob) {\n          // 解码并显示图片\n          const ctx = document.getElementById('camera_result').getContext('2d');\n          const canvas_result = document.getElementById('camera_result');\n          // 将接收到的 blob 格式的图像数据转换为 URL\n          const imageUrl = URL.createObjectURL(imageData);\n          const img = new Image();\n          img.onload = () => {\n            // 设置画布的宽度和高度\n            canvas_result.width = img.width;\n            canvas_result.height = img.height;\n            // 绘制图像到画布上\n            ctx.drawImage(img, 0, 0);\n            // 释放 URL 对象\n            URL.revokeObjectURL(imageUrl);\n          };\n          // 设置图像的 src\n          img.src = imageUrl;\n        } else {\n          console.error(\"Received data is not a Blob object.\");\n        }\n      };\n    }\n    function closeDetection() {\n      flag = 0;\n      console.log(\"关闭检测\");\n    }\n    const __returned__ = {\n      video,\n      video_result,\n      get flag() {\n        return flag;\n      },\n      set flag(v) {\n        flag = v;\n      },\n      canvas,\n      canvas_result,\n      ctx,\n      socket,\n      connection,\n      reconnection,\n      getCamera,\n      closeCamera,\n      getDetection,\n      closeDetection,\n      get instance() {\n        return instance;\n      },\n      ref,\n      onMounted,\n      onBeforeUnmount\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["instance","ref","onMounted","onBeforeUnmount","video","video_result","flag","canvas","canvas_result","ctx","socket","WebSocket","console","log","getCamera","connection","reconnection","onopen","setTimeout","value","document","getElementById","getContext","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","mediaRecorder","MediaRecorder","ondataavailable","event","data","size","createElement","width","videoWidth","height","videoHeight","drawImage","base64ImageData","toDataURL","send","start","catch","err","closeCamera","tracks","getTracks","forEach","x","stop","getDetection","onmessage","imageData","Blob","imageUrl","URL","createObjectURL","img","Image","onload","revokeObjectURL","src","error","closeDetection"],"sources":["C:/Users/31136/Desktop/face_anti_front/src/components/onlineAlaysis.vue"],"sourcesContent":["<template>\r\n <div class=\"container\">\r\n    \r\n    <div style=\"display: flex;flex-direction: row;\">\r\n        <div>\r\n            <video  src=\"\" ref=\"video\" id=\"video\"></video>\r\n            <canvas id=\"camera\"></canvas>\r\n        </div>\r\n        <div>\r\n            <canvas id=\"camera_result\"></canvas>\r\n        </div>\r\n        \r\n    </div>\r\n    <div class=\"botton_box\">\r\n        <el-button type=\"primary\" @click=\"getCamera()\">打开摄像头</el-button>\r\n        <el-button type=\"danger\" @click=\"closeCamera()\">关闭摄像头</el-button>\r\n        <el-button type=\"primary\" @click=\"getDetection()\">开始检测</el-button>\r\n        <el-button type=\"danger\" @click=\"closeDetection()\">关闭检测</el-button>\r\n        <el-button type=\"primary\" @click=\"function(){}\">保存截图</el-button>\r\n        \r\n    </div>\r\n    \r\n </div>\r\n</template>\r\n\r\n<script setup>\r\nimport instance from '@/service';\r\nimport {ref,onMounted,onBeforeUnmount,} from 'vue';\r\nconst video = ref()\r\nconst video_result = ref()\r\nlet flag = 0\r\nconst canvas = ref()\r\nconst canvas_result = ref()\r\nconst ctx = ref()\r\nconst socket = new WebSocket('ws://localhost:8888');\r\nonMounted(()=>{\r\n    console.log('正在打开摄像头。。。')\r\n    getCamera()\r\n    //连接后端socket\r\n    connection()\r\n    reconnection()\r\n})\r\nfunction connection(){\r\n    socket.onopen = ()=>{\r\n        console.log('socket 已打开...')\r\n    }\r\n}\r\nasync function reconnection(){\r\n    console.log('Attempting to reconnect...');\r\n    setTimeout(connection(), 3000); // 3秒后尝试重新连接\r\n}\r\nfunction getCamera(){\r\n    canvas.value = document.getElementById('camera');\r\n    ctx.value = canvas.value.getContext('2d');\r\n    if(navigator.mediaDevices){\r\n        navigator.mediaDevices.getUserMedia({video:true,audio:false}).then((stream)=>{\r\n            video.value.srcObject = stream;\r\n            video.value.play();\r\n            let  mediaRecorder = new MediaRecorder(stream);\r\n            mediaRecorder.ondataavailable = (event) => {\r\n            if (event.data && event.data.size > 0 && flag === 1) {\r\n                const canvas = document.createElement('canvas');\r\n                canvas.width = video.value.videoWidth;\r\n                canvas.height = video.value.videoHeight;\r\n                const ctx = canvas.getContext('2d');\r\n                ctx.drawImage(video.value, 0, 0, canvas.width, canvas.height);\r\n                // 将图像数据编码为 base64 字符串\r\n                const base64ImageData = canvas.toDataURL('image/jpeg');\r\n                // 发送 base64 编码后的图像数据给后端处理\r\n                //如果socket连接后才开始发送\r\n                socket.send(base64ImageData);\r\n            }\r\n    };\r\n            mediaRecorder.start(33);\r\n        }).catch((err)=>{\r\n            console.log(err)\r\n        })\r\n    }else{\r\n        //防止浏览器版本旧不支持mediaDevices\r\n        navigator.mediaDevices={}\r\n    }\r\n}\r\nonBeforeUnmount(()=>{\r\n    //closeCamera();\r\n})\r\nfunction closeCamera(){\r\n    let stream = video.value.srcObject;\r\n    if (!stream) return;\r\n    let tracks = stream.getTracks();\r\n    tracks.forEach((x) => {\r\n    x.stop();\r\n    });\r\n}\r\nfunction getDetection(){\r\n    flag = 1;\r\n    console.log(\"开始检测\")\r\n    socket.onmessage = (event) => {\r\n    console.log(event.data);\r\n    let imageData = event.data;\r\n    // 检查是否为 Blob 对象\r\n    if (imageData instanceof Blob) {\r\n        // 解码并显示图片\r\n        const ctx = document.getElementById('camera_result').getContext('2d');\r\n        const canvas_result = document.getElementById('camera_result');\r\n        // 将接收到的 blob 格式的图像数据转换为 URL\r\n        const imageUrl = URL.createObjectURL(imageData);\r\n        const img = new Image();\r\n        img.onload = ()=>{\r\n            // 设置画布的宽度和高度\r\n            canvas_result.width = img.width;\r\n            canvas_result.height = img.height;\r\n            // 绘制图像到画布上\r\n            ctx.drawImage(img, 0, 0);\r\n            // 释放 URL 对象\r\n            URL.revokeObjectURL(imageUrl);\r\n        };\r\n        // 设置图像的 src\r\n        img.src = imageUrl;\r\n    } else {\r\n        console.error(\"Received data is not a Blob object.\");\r\n    }\r\n};\r\n}\r\n\r\nfunction closeDetection(){\r\n    flag = 0;\r\n    console.log(\"关闭检测\")\r\n}\r\n\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.container{\r\n    display: flex;\r\n    width: 84vw;\r\n    max-height: 90vh;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    background-color: #f0f0f0;\r\n    padding-top: 1%;\r\n    padding-bottom: 3%;\r\n}\r\n#camera{\r\n    width:0;\r\n    height:0;\r\n    display: none;\r\n}\r\nvideo , #camera_result{\r\n    width:40vw;\r\n    margin-left: 10px;\r\n}\r\n.botton_box{\r\n    margin-top: 10px;\r\n    display: flex;\r\n    flex-direction: row;\r\n}\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}